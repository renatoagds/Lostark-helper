 <div class="w-full">
  <ng-container *ngIf="roster$ | async as roster">
    <div class="flex items-center flex-col gap-5 mt-10 text-4xl text-center" *ngIf="roster.length === 0">
      No characters in your roster, please add some in the roster page
      <br>
      <a class="btn btn-lg" routerLink="/roster">
        Click here to navigate to the roster manager and add your first
        character
      </a>
    </div>
    <ng-container *ngIf="roster.length > 0">
      <ng-container *ngIf="completion$ | async as completion">
        <ng-container *ngIf="energy$ | async as energy">
          <ng-container *ngIf="scrolling$ | async as scrolling">
            <ng-container *ngIf="tableDisplay$ | async as display">
              <ng-container *ngIf="charactersDisplay$ | async as chDisplay">
                <ng-container *ngIf="categoriesDisplay$ | async as categories">
                  <!-- Templates -->
                  <!-- Task Description Template -->
                  <ng-template #taskDescription let-entry let-label="label" let-flex="flex">
                    <div class="inline-flex justify-start items-center" [class]="flex ?? 'flex-1'">
                      <figure class="p-2 xl:p-1">
                        <img *ngIf="entry" src="./assets/icons/{{entry}}" alt="" class="w-6 xl:w-10">
                      </figure>
                      <p class="font-semibold text-sm">{{label}}</p>
                    </div>
                  </ng-template>
                  <!-- Button Complete Template -->
                  <ng-template #buttonComplete let-entry let-index="index">
                    <button class="btn btn-sm w-10"
                      [disabled]="entry.completion[index] >= entry.task.amount"
                      (click)="markAsDone(completion, energy, roster[index], entry.task, roster, true, display.dailyReset, display.weeklyReset, display.biWeeklyReset, $event)">
                      {{entry.completion[index]}}/{{entry.task.amount}}
                    </button>
                  </ng-template>
                  <!-- Button Reset Template -->
                  <ng-template #buttonReset let-entry let-index="index">
                    <button class="btn btn-xs"
                      [disabled]="entry.completion[index] === 0"
                      (click)="markAsDone(completion, energy, roster[index], entry.task, roster, false, display.dailyReset, display.weeklyReset, display.biWeeklyReset)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l1.903 1.903h-3.183a.75.75 0 1 0 0 1.5h4.992a.75.75 0 0 0 .75-.75V4.356a.75.75 0 0 0-1.5 0v3.18l-1.9-1.9A9 9 0 0 0 3.306 9.67a.75.75 0 1 0 1.45.388Zm15.408 3.352a.75.75 0 0 0-.919.53 7.5 7.5 0 0 1-12.548 3.364l-1.902-1.903h3.183a.75.75 0 0 0 0-1.5H2.984a.75.75 0 0 0-.75.75v4.992a.75.75 0 0 0 1.5 0v-3.18l1.9 1.9a9 9 0 0 0 15.059-4.035.75.75 0 0 0-.53-.918Z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </ng-template>
                  <!-- Char Side Template -->
                  <ng-template #charSide let-entry>
                    <div class="p-2 flex items-center justify-center flex-col bg-neutral/20 rounded-2xl text-white lg:min-w-32 lg:max-w-40">
                      <figure class="w-12">
                        <img src="./assets/icons/classes/class_{{entry.class?.toString()?.padStart(2,'0')}}.png" alt="">
                      </figure>
                      <span class="font-black">{{ entry.name }}</span>
                      <span>{{ entry.ilvl }}</span>
                    </div>
                  </ng-template>
                  <!-- Task Card Template -->
                  <ng-template #taskCard let-entry let-index="index" let-useEnergy="useEnergy">
                    <div
                      class="card card-side card-bordered bg-neutral text-neutral-content shadow-xl"
                      [class.bg-success]="entry.completion[index] === entry.task.amount || entry.allDone"
                      [class.text-success-content]="entry.completion[index] === entry.task.amount || entry.allDone">
                      <ng-container *ngTemplateOutlet="taskDescription;context:{$implicit: entry.task.iconPath, label: entry?.task?.label }"></ng-container>
                      <div class="py-1 px-4 flex justify-end items-center flex-1 gap-2">
                        <div *ngIf="entry.hasEnergy && entry.energy[index].amount > 0 && useEnergy"
                          class="radial-progress text-xs"
                          [class.text-success]="entry.energy[index].amount <= 40"
                          [class.text-warning]="entry.energy[index].amount > 40"
                          [class.text-error]="entry.energy[index].amount >= 80"
                          [style]="'--value:'+( entry.energy[index].amount ?? 0 )+';--size:2rem'"
                          role="progressbar">
                          {{entry.energy[index].amount ?? 0}}
                        </div>
                        <ng-container *ngTemplateOutlet="buttonComplete;context:{$implicit: entry, index }"></ng-container>
                        <ng-container *ngTemplateOutlet="buttonReset;context:{$implicit: entry, index }"></ng-container>
                      </div>
                    </div>
                  </ng-template>
                  <!-- Characters Template -->
                  <ng-template #charsDisplay let-entry let-key="key" let-bg="bg" let-hasBiWeekly="hasBiWeekly" let-biWeeklyEntry="biWeeklyEntry">
                    <div *ngFor="let character of chDisplay; index as i" class="card lg:card-side card-bordered bg-neutral text-neutral-content shadow-xl">
                      <ng-container *ngTemplateOutlet="charSide;context:{$implicit: character }"></ng-container>
                      <div class="card-body flex flex-col justify-between p-4">
                        <div class="grid gap-2">
                          <ng-container *ngFor="let row of entry.data; trackBy: trackByEntry; even as even">
                            <ng-container *ngIf="row.completionData[i].tracked && character.ilvl >= row.task.minIlvl && character.ilvl < row.task.maxIlvl">
                                <ng-container *ngTemplateOutlet="taskCard;context:{$implicit: row, index: i, useEnergy: true }"></ng-container>
                            </ng-container>
                          </ng-container>
                        </div>
                        <!-- Bi-Weekly Cards -->
                        <ng-container *ngIf="hasBiWeekly">
                          <ng-container *ngFor="let row of biWeeklyEntry.data; trackBy: trackByEntry; even as even">
                            <div *ngIf="row.completionData[i].tracked && character.ilvl >= row.task.minIlvl && character.ilvl < row.task.maxIlvl">
                              <div class="divider">Bi-Weekly</div>
                              <ng-container *ngTemplateOutlet="taskCard;context:{$implicit: row, index: i, useEnergy: false }"></ng-container>
                            </div>
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>
                  </ng-template>
                  <!-- Roster Template -->
                  <ng-template #rosterDisplay let-entry let-key="key" let-bg="bg">
                    <div class="card lg:card-side card-bordered bg-neutral text-neutral-content shadow-xl">
                      <div class="flex flex-col items-center justify-center p-2 rounded-2xl lg:min-w-32 lg:max-w-40" [class]="bg">
                        <p class="card-title text-lg">Roster</p>
                      </div>
                      <div class="card-body p-2 grid lg:grid-cols-2">
                        <ng-container *ngFor="let row of entry.data; trackBy: trackByEntry; even as even">
                          <ng-container *ngIf="row.available">
                            <ng-container *ngTemplateOutlet="taskCard;context:{$implicit: row, index: 0, useEnergy: false }"></ng-container>
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>
                  </ng-template>
                  <!-- Templates -->
                  <!-- Countdown -->
                  <div class="stats shadow-xl w-full">
                    <div *ngIf="nextDailyReset$ | async as reset" class="stat">
                      <div class="stat-figure text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                      </div>
                      <div class="stat-title">Next Daily Reset</div>
                      <div class="stat-value text-primary">
                        <nz-countdown [nzValue]="reset.utc"></nz-countdown>
                      </div>
                    </div>
                    <div *ngIf="nextWeeklyReset$ | async as reset" class="stat">
                      <div class="stat-figure text-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                      </div>
                      <div class="stat-title">Next Weekly Reset</div>
                      <div class="stat-value text-secondary">
                        {{ reset.date }}
                      </div>
                      <div class="stat-desc">
                        <nz-countdown [nzValue]="reset.utc"></nz-countdown>
                      </div>
                    </div>
                    <div *ngIf="nextBiWeeklyReset$ | async as reset" class="stat">
                      <div class="stat-figure text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.017.22-.032.441-.046.662M19.5 12l3-3m-3 3-3-3m-12 3c0 1.232.046 2.453.138 3.662a4.006 4.006 0 0 0 3.7 3.7 48.656 48.656 0 0 0 7.324 0 4.006 4.006 0 0 0 3.7-3.7c.017-.22.032-.441.046-.662M4.5 12l3 3m-3-3-3 3" />
                        </svg>
                      </div>
                      <div class="stat-title">Next Bi-Weekly Reset</div>
                      <div class="stat-value text-primary">
                        {{ reset.date }}
                      </div>
                      <div class="stat-desc">
                        <nz-countdown [nzValue]="reset.utc"></nz-countdown>
                      </div>
                    </div>
                  </div>
                  <!-- Options -->
                  <div class="divider"></div>
                  <div class="collapse collapse-arrow bg-neutral">
                    <input type="checkbox" /> 
                    <div class="collapse-title">Options</div>
                    <div class="collapse-content"> 
                      <div class="form-control w-fit">
                        <label class="label cursor-pointer justify-start gap-4">
                          <input type="checkbox" [checked]="forceShowHiddenCharacter$" class="checkbox" [ngModel]="forceShowHiddenCharacter$ | async" (ngModelChange)="forceShowHiddenCharacter$.next($event)" />
                          <span class="label-text">Show your hidden characters</span> 
                        </label>
                        <ng-container *ngIf="rawRoster$ | async as roster">
                          <label class="label cursor-pointer justify-start gap-4">
                            <input type="checkbox" [checked]="roster.showAllTasks" class="checkbox" [(ngModel)]="roster.showAllTasks" (ngModelChange)="saveRoster(roster)" *ngIf="roster.characters.length > 0">
                            <span class="label-text">Show all tasks</span> 
                          </label>
                        </ng-container>
                      </div>
                    </div>
                  </div>
                  <!-- Tickets -->
                  <div *ngIf="rawRoster$ | async as roster" class="collapse collapse-arrow bg-neutral mt-2">
                    <input type="checkbox" [checked]="ticketsTrackingOpened" [(ngModel)]="ticketsTrackingOpened" (change)="ticketsTrackingOpenedChange()" /> 
                    <div class="collapse-title">
                      Tickets Tracking
                    </div>
                    <div class="collapse-content flex flex-col gap-2"> 
                      <div *ngFor="let character of chDisplay; index as i" class="card lg:card-side card-bordered bg-neutral text-neutral-content shadow-xl">
                        <ng-container *ngTemplateOutlet="charSide;context:{$implicit: character }"></ng-container>
                        <div class="card-body flex flex-col p-4">
                          <div class="grid lg:grid-cols-2 gap-2">
                            <ng-container *ngIf="tickets$ | async as tickets">
                              <div *ngFor="let ticket of tickets" class="card card-side card-bordered bg-neutral text-neutral-content shadow-xl">
                                <ng-container *ngTemplateOutlet="taskDescription;context:{$implicit: ticket.icon, label: ticket.name, flex: 'grow' }"></ng-container>
                                <div class="flex justify-end items-center pr-2">
                                  <input type="number" [(ngModel)]="character.tickets[ticket.key]" (ngModelChange)="saveRoster(roster)" class="input input-sm w-16" />
                                </div>
                              </div>
                            </ng-container>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Daily -->
                  <div class="divider"></div>
                  <div class="w-full">
                    <div class="collapse collapse-arrow w-full bg-green-500/20 text-white shadow-xl">
                      <input id="daily" type="checkbox" class="peer" [checked]="categories.daily" [(ngModel)] ="categories.daily" (ngModelChange)="categoriesDisplay$.next(categories)" /> 
                      <div class="collapse-title text-3xl text-white">Daily</div>
                      <div class="collapse-content peer-checked:p-2">
                        <!-- Daily Roster -->
                        <div class="divider"></div>
                        <ng-container *ngIf="display?.data?.dailyRoster?.data as data">
                          <ng-container *ngIf="data.length > 0">
                            <ng-container *ngTemplateOutlet="rosterDisplay;context:{$implicit: display.data.dailyRoster, key:'dailyRoster', bg: 'bg-green-500/40' }"></ng-container>
                          </ng-container>
                        </ng-container>
                        <!-- Daily Character -->
                        <div class="divider"></div>
                        <ng-container *ngIf="display?.data?.dailyCharacter?.data as data">
                          <ng-container *ngIf="data.length > 0">
                            <div class="grid 2xl:grid-cols-2 gap-2">
                              <ng-container *ngTemplateOutlet="charsDisplay;context:{$implicit: display.data.dailyCharacter, key:'dailyCharacter', bg: 'bg-green-500/40' }"></ng-container>
                            </div>
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>
                  </div>
                  <!-- Weekly -->
                  <div class="divider"></div>
                  <div class="w-full">
                    <div class="collapse collapse-arrow w-full bg-violet-500/20 text-neutral-content shadow-xl">
                      <input id="weekly" type="checkbox" class="peer" [checked]="categories.weekly" [(ngModel)]="categories.weekly" (ngModelChange)="categoriesDisplay$.next(categories)" /> 
                      <div class="collapse-title text-3xl text-white">Weekly</div>
                      <div class="collapse-content peer-checked:p-2">
                        <!-- <h3 class="card-title text-3xl text-white"></h3> -->
                        <!-- Weekly Roster -->
                        <div class="divider"></div>
                        <ng-container *ngIf="display?.data?.weeklyRoster?.data as data">
                          <ng-container *ngIf="data.length > 0">
                            <ng-container *ngTemplateOutlet="rosterDisplay;context:{$implicit: display.data.weeklyRoster, key:'weeklyRoster', bg: 'bg-violet-500/40' }"></ng-container>
                          </ng-container>
                        </ng-container>
                        <!-- Weekly Character -->
                        <div class="divider"></div>
                        <ng-container *ngIf="display?.data?.weeklyCharacter?.data as data">
                          <ng-container *ngIf="data.length > 0">
                            <div class="grid 2xl:grid-cols-2 gap-2">
                              <ng-container *ngTemplateOutlet="charsDisplay;context:{$implicit: display.data.weeklyCharacter, key:'weeklyCharacter', bg: 'bg-violet-500/40', hasBiWeekly: display.data.biWeeklyCharacter.data.length > 0, biWeeklyEntry: display.data.biWeeklyCharacter }"></ng-container>
                            </div>
                          </ng-container>
                        </ng-container>
                      </div>
                    </div>
                  </div>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>
 </div>
